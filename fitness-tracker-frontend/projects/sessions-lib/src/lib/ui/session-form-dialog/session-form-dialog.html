<form class="session-form" [formGroup]="sessionForm" (ngSubmit)="onSave()">
  <h2 mat-dialog-title>{{ isEditMode() ? 'Edit session' : 'Create a new session with exercises' }}</h2>

  <mat-dialog-content class="session-dialog">
    <p class="required-hint">* Required fields</p>
    <p class="dialog-subtitle">Choose a plan, name your session, then order exercises with sets, reps, and weight.</p>

    <div class="session-details">
      <div class="name-row">
        <mat-form-field appearance="outline">
          <mat-label>Session name</mat-label>
          <input matInput formControlName="name" placeholder="Upper Body Blast" required />
          @if (sessionForm.get('name')?.invalid && sessionForm.get('name')?.touched) {
          <mat-error>Enter a session name (min 2 characters)</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="session-details-divider" aria-hidden="true"></div>

      <div class="plan-order-grid">
        <mat-form-field appearance="outline" class="plan-select-field">
          <mat-label>Plan</mat-label>
          <mat-select formControlName="planId" placeholder="Select a plan" required panelClass="plan-select-panel">
            @for (plan of plans; track plan.id) {
            <mat-option [value]="plan.id">
              <div class="plan-option">
                <span class="plan-name">{{ plan.name }}</span>
                <span class="plan-pill">Plan</span>
              </div>
            </mat-option>
            }
          </mat-select>
          @if (sessionForm.get('planId')?.invalid && sessionForm.get('planId')?.touched) {
          <mat-error>Select a plan</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Position</mat-label>
          <input matInput type="number" formControlName="orderID" min="1" max="30" placeholder="1-30" required />
          <mat-hint>Position inside the plan</mat-hint>
          @if (sessionForm.get('orderID')?.invalid && sessionForm.get('orderID')?.touched) {
          <mat-error>Position is required (1-30)</mat-error>
          }
        </mat-form-field>
      </div>
    </div>

    <section class="timeline-section">
      <div class="timeline-header">
        <div class="title-row">
          <h3>Exercise order</h3>
          <span class="count-chip">{{ exerciseControls.length }}</span>
        </div>
        @if (exerciseControls.length > 1) {
        <span class="hint">Drag the cards to rearrange.</span>
        }
      </div>

      <div class="timeline-wrapper" cdkDropList cdkDropListOrientation="vertical"
        (cdkDropListDropped)="onReorder($event)" [cdkDropListDisabled]="exerciseControls.length <= 1">
        @for (exerciseGroup of exerciseControls; track exerciseGroup.value.exerciseId; let i = $index) {
        <div class="timeline-item" cdkDrag cdkDragLockAxis="y" [cdkDragStartDelay]="90"
          [formGroup]="exerciseGroup" [cdkDragDisabled]="exerciseControls.length <= 1">
          <div class="timeline-marker" aria-hidden="true"></div>
          <div class="exercise-card" cdkDragHandle>
            <div class="exercise-header">
              <div class="left">
                <div class="order-chip">{{ i + 1 }}</div>
                <div class="exercise-title">
                  <h4>{{ getExerciseName(exerciseGroup.value.exerciseId) }}</h4>
                  <span class="category-chip">{{ getExerciseCategory(exerciseGroup.value.exerciseId) }}</span>
                </div>
              </div>
              <div class="actions">
                <button mat-icon-button color="warn" type="button" (click)="removeExercise(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="exercise-stats">
              <mat-form-field appearance="outline">
                <mat-label>Sets</mat-label>
                <input matInput type="number" formControlName="plannedSets" min="1" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Reps</mat-label>
                <input matInput type="number" formControlName="plannedReps" min="1" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Weight (kg)</mat-label>
                <input matInput type="number" formControlName="plannedWeight" min="0" />
                <mat-hint>0 kg only for Bodyweight</mat-hint>
              </mat-form-field>
            </div>
          </div>
        </div>
        }
      </div>
    </section>

    @if (showAddForm) {
    <section #addFormRef class="add-form" [formGroup]="addExerciseForm">
      <div class="add-top">
        <mat-form-field appearance="outline">
          <mat-label>Select exercise</mat-label>
          <mat-select formControlName="exerciseId" required>
            @for (exercise of availableExercises(); track exercise.id) {
            <mat-option [value]="exercise.id">
              {{ exercise.name }} - {{ exercise.category }}
            </mat-option>
            }
          </mat-select>
          @if (addExerciseForm.get('exerciseId')?.invalid && addExerciseForm.get('exerciseId')?.touched) {
          <mat-error>Select an exercise</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-divider"></div>

      <div class="add-grid">
        <mat-form-field appearance="outline">
          <mat-label>Sets</mat-label>
          <input matInput type="number" formControlName="plannedSets" min="1" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Reps</mat-label>
          <input matInput type="number" formControlName="plannedReps" min="1" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Weight (kg)</mat-label>
          <input matInput type="number" formControlName="plannedWeight" min="0" />
          <mat-hint>0 kg only for Bodyweight</mat-hint>
        </mat-form-field>
      </div>

      <div class="add-actions">
        <button mat-button class="cancel-btn" type="button" (click)="onToggleAddForm()">
          Cancel
        </button>
        <button mat-raised-button class="create-btn" type="button" (click)="onAddExercise()">
          <mat-icon>add_circle</mat-icon>
          Add to timeline
        </button>
      </div>
    </section>
    }
  </mat-dialog-content>

  <mat-dialog-actions align="end" class="dialog-actions">
    <button class="add-dot" type="button" (click)="onToggleAddForm()">
      <span class="dot">
        <mat-icon>add</mat-icon>
      </span>
      <span>Add exercise</span>
    </button>
    <span class="actions-spacer"></span>
    <button mat-button class="cancel-btn" type="button" (click)="onCancel()">Cancel</button>
    <button mat-raised-button [class.update-btn]="isEditMode()" [class.create-btn]="!isEditMode()" type="submit"
      [disabled]="isSaving || sessionForm.invalid || !exercisesArray.length || (isEditMode() && !sessionForm.dirty)">
      {{ isEditMode() ? 'Update' : 'Create session' }}
    </button>
  </mat-dialog-actions>
</form>
