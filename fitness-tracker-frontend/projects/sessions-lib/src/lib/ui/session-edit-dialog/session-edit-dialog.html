<form class="session-form" [formGroup]="sessionForm" (ngSubmit)="onSave()">
  <h2 mat-dialog-title>Edit session</h2>

  <mat-dialog-content class="session-dialog">
    <p class="required-hint">* Required fields</p>
    <p class="dialog-subtitle">Choose a plan, name your session, then order exercises with sets, reps, and weight.</p>

    <div class="session-details">
      <div class="name-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Session name</mat-label>
          <input matInput formControlName="name" placeholder="Upper Body Blast" required />
          @if (sessionForm.get('name')?.invalid && sessionForm.get('name')?.touched) {
          <mat-error>Enter a session name (min 2 characters)</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="plan-order-grid">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Plan</mat-label>
          <mat-select formControlName="planId" placeholder="Select a plan" required>
            @for (plan of plans; track plan.id) {
            <mat-option [value]="plan.id">{{ plan.name }}</mat-option>
            }
          </mat-select>
          @if (sessionForm.get('planId')?.invalid && sessionForm.get('planId')?.touched) {
          <mat-error>Select a plan</mat-error>
          }
        </mat-form-field>
        <div class="field-divider"></div>
      </div>
    </div>

    <section class="timeline-section">
      <div class="timeline-header">
        <div class="title-row">
          <h3>Exercises: <span class="count-chip inline-chip">{{ exerciseControls.length }}</span></h3>
        </div>
        @if (exerciseControls.length > 1) {
        <span class="hint">Drag the cards to rearrange.</span>
        }
        @if (exerciseControls.length) {
        <span class="hint required-hint">Fields marked with * must be filled in.</span>
        }
      </div>

      @if (exerciseControls.length) {
      <div class="timeline-wrapper" cdkDropList cdkDropListOrientation="vertical"
        (cdkDropListDropped)="onReorder($event)" [cdkDropListDisabled]="exerciseControls.length <= 1">
        @for (exerciseGroup of exerciseControls; track exerciseGroup.value.exerciseId; let i = $index) {
        <div class="timeline-item" cdkDrag cdkDragLockAxis="y" [cdkDragStartDelay]="80" [formGroup]="exerciseGroup"
          [cdkDragDisabled]="exerciseControls.length <= 1">
          <div class="timeline-marker" aria-hidden="true"></div>
          <div class="exercise-card" cdkDragHandle>
            <div class="exercise-header">
              <div class="left">
                <div class="exercise-icon">
                  <mat-icon>fitness_center</mat-icon>
                </div>
                <div class="exercise-title">
                  <h4>{{ getExerciseName(exerciseGroup.value.exerciseId) }}</h4>
                </div>
              </div>
              <div class="right">
                <div class="order-chip">
                  <mat-icon>format_list_numbered</mat-icon>
                  <span class="order-value">{{ i + 1 }}</span>
                </div>
                <span class="category-chip">{{ getExerciseCategory(exerciseGroup.value.exerciseId) }}</span>
              </div>
              <div class="actions">
                <button mat-icon-button type="button" (click)="removeExercise(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="exercise-divider"></div>

            <div class="exercise-stats">
              <mat-form-field appearance="outline">
                <mat-label>Sets</mat-label>
                <input matInput type="number" formControlName="plannedSets" min="1" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Reps</mat-label>
                <input matInput type="number" formControlName="plannedReps" min="1" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Weight (kg)</mat-label>
                <input matInput type="number" formControlName="plannedWeight"
                  [min]="requiresPositiveWeight(exerciseGroup.value.exerciseId) ? 1 : 0" />
                <mat-hint>{{ getWeightHint(exerciseGroup.value.exerciseId) }}</mat-hint>
              </mat-form-field>
            </div>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="empty-exercises">
        <mat-icon class="empty-icon">event_busy</mat-icon>
        <p>No exercises added to this session yet</p>
      </div>
      }
    </section>

    @if (showAddForm) {
    <section #addFormRef class="add-form" [formGroup]="addExerciseForm">
      <div class="add-hint">
        <span class="hint">Fields marked with * must be filled in.</span>
      </div>
      <div class="add-top">
        <mat-form-field appearance="outline">
          <mat-label>{{ hasAvailableExercises() ? 'Select exercise' : 'No exercises available' }}</mat-label>
          <mat-select formControlName="exerciseId" required [disabled]="!hasAvailableExercises()">
            <mat-select-trigger>
              @if (hasAvailableExercises()) {
              {{ getExerciseName(addExerciseForm.get('exerciseId')?.value) || 'Select exercise' }}
              } @else {
              No more exercises available to add
              }
            </mat-select-trigger>
            @for (exercise of availableExercises(); track exercise.id) {
            <mat-option [value]="exercise.id">
              <div class="exercise-option">
                <span class="option-name">{{ exercise.name }}</span>
                <span class="category-chip option-category">{{ exercise.category || 'No category' }}</span>
              </div>
            </mat-option>
            }
          </mat-select>
          @if (addExerciseForm.get('exerciseId')?.invalid && addExerciseForm.get('exerciseId')?.touched) {
          <mat-error>{{ hasAvailableExercises() ? 'Select an exercise' : 'No exercises available to add' }}</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-divider"></div>

      <div class="add-grid">
        <mat-form-field appearance="outline">
          <mat-label>Sets</mat-label>
          <input matInput type="number" formControlName="plannedSets" min="1" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Reps</mat-label>
          <input matInput type="number" formControlName="plannedReps" min="1" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Weight (kg)</mat-label>
          <input matInput type="number" formControlName="plannedWeight"
            [min]="requiresPositiveWeight(addExerciseForm.get('exerciseId')?.value) ? 1 : 0" />
          <mat-hint>{{ getAddFormWeightHint() }}</mat-hint>
        </mat-form-field>
      </div>

      <div class="add-actions">
        <button mat-button class="cancel-btn" type="button" (click)="onToggleAddForm()">
          Cancel
        </button>
        <button mat-raised-button class="create-btn" type="button" (click)="onAddExercise()"
          [disabled]="addExerciseForm.invalid || !addExerciseForm.get('exerciseId')?.value">
          <mat-icon>add_circle</mat-icon>
          Add to timeline
        </button>
      </div>
    </section>
    }
  </mat-dialog-content>

  <mat-dialog-actions align="end" class="dialog-actions">
    <button mat-raised-button class="create-btn" type="button" (click)="onToggleAddForm()">
      <mat-icon>add_circle</mat-icon>
      <span>Add exercise</span>
    </button>
    <span class="actions-spacer"></span>
    <button mat-button class="cancel-btn" type="button" (click)="onCancel()">Cancel</button>
    <button mat-raised-button [class.update-btn]="isEditMode()" [class.create-btn]="!isEditMode()" type="submit"
      [disabled]="isSaving || sessionForm.invalid || (isEditMode() && !sessionForm.dirty && !exercisesArray.dirty)">
      {{ isEditMode() ? 'Update' : 'Create session' }}
    </button>
  </mat-dialog-actions>
</form>